variables:
    - name: SYMFONY_ENV
      value: prod

tasks:
    images:
        build:
            services:
                web:
                    image: ${IMAGE_NAME}
                    naming_strategy: sha1
    deployment:
        deploy:
            cluster: ${CLUSTER}
            environment:
                name: '"sfdemo-" ~ code_reference.branch'
            services:
                sshforward:
                    specification:
                        ports:
                            - 9000
                        environment_variables:
                            SSH_FORWARD_PASSWORD: ${SSH_FORWARD_PASSWORD}
                web:
                    specification:
                        accessibility:
                            from_external: true
                        environment_variables:
                            - name: SYMFONY_ENV
                              value: ${SYMFONY_ENV}

pipelines:
    - name: Production
      condition: condition: 'code_reference.branch matches "/master/"'
      tasks: [ images, deployment ]
    - name: Remote
      condition: 'code_reference.branch matches "/^feature/"'
      tasks: [ images, deployment ]
      variables:
          - name: SYMFONY_ENV
            value: dev
